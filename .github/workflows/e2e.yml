name: E2E Tests

on:
  # Run after deploy workflow completes
  workflow_run:
    workflows: ["deploy"]
    types: [completed]

  # Allow manual triggering with custom URL
  workflow_dispatch:
    inputs:
      base_url:
        description: 'Base URL to test against'
        required: true
        default: 'https://wcpos.expo.app'

concurrency:
  group: e2e-${{ github.event.workflow_run.head_branch || github.ref }}
  cancel-in-progress: true

jobs:
  e2e:
    # Only run if the deploy workflow succeeded
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ðŸ— Checkout repository
        uses: actions/checkout@v4
        with:
          # For workflow_run events, checkout the branch that triggered the deploy
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: ðŸ“¥ Download deployment info
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@v4
        with:
          name: deployment-info
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: ðŸ”— Determine Base URL
        id: get-url
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Use the URL provided in workflow_dispatch
            echo "url=${{ github.event.inputs.base_url }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.workflow_run.head_branch }}" = "main" ]; then
            # Production deployment
            echo "url=https://wcpos.expo.app" >> $GITHUB_OUTPUT
          else
            # Preview deployment - try to get URL from artifact or use production as fallback
            if [ -f deployment-info ]; then
              URL=$(cat deployment-info | grep -oE 'https://[a-zA-Z0-9.-]+\.expo\.app[^ ]*' | head -1 || echo "")
              if [ -n "$URL" ]; then
                echo "url=$URL" >> $GITHUB_OUTPUT
              else
                echo "url=https://wcpos.expo.app" >> $GITHUB_OUTPUT
              fi
            else
              # Fallback to production if no deployment info
              echo "url=https://wcpos.expo.app" >> $GITHUB_OUTPUT
            fi
          fi

      - name: ðŸ— Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.17.0

      - name: ðŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          UNIWIND_AUTH_TOKEN: ${{ secrets.UNIWIND_AUTH_TOKEN }}

      - name: ðŸŽ­ Install Playwright browsers
        run: cd apps/main && npx playwright install --with-deps chromium

      - name: ðŸ§ª Run E2E tests
        id: e2e-tests
        run: cd apps/main && npx playwright test
        env:
          BASE_URL: ${{ steps.get-url.outputs.url }}
          CI: true

      - name: ðŸ“Š Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ github.event.workflow_run.head_sha || github.sha }}
          path: apps/main/playwright-report/
          retention-days: 30

      - name: ðŸ“¸ Upload test screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-screenshots-${{ github.event.workflow_run.head_sha || github.sha }}
          path: apps/main/test-results/
          retention-days: 7

      - name: ðŸ’¬ Comment on PR with test results
        if: github.event_name == 'workflow_run' && github.event.workflow_run.event == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Get PR number from the workflow run
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`,
              state: 'open'
            });

            if (prs.length === 0) return;

            const prNumber = prs[0].number;
            const testsPassed = '${{ steps.e2e-tests.outcome }}' === 'success';
            const baseUrl = '${{ steps.get-url.outputs.url }}';

            let body = `## ðŸ§ª E2E Test Results\n\n`;
            body += testsPassed
              ? `âœ… **All tests passed!**\n\n`
              : `âŒ **Some tests failed.**\n\n`;
            body += `Tested against: ${baseUrl}\n\n`;
            body += `[View full report](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;

            // Find existing E2E comment to update
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const existingComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('E2E Test Results')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }
