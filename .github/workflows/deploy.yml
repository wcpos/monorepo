name: deploy

on:
  workflow_dispatch:
    inputs:
      target:
        description: Deploy as preview or production
        type: choice
        required: true
        default: preview
        options:
          - preview
          - production
      skip_e2e:
        description: Skip E2E tests
        type: boolean
        default: false
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize]

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

env:
  EXPO_USE_FAST_RESOLVER: true

jobs:
  deploy:
    name: ğŸš€ Deploy
    runs-on: ubuntu-latest
    outputs:
      deployment_url: ${{ steps.get-url.outputs.url }}
      is_production: ${{ steps.get-url.outputs.is_production }}
    steps:
      - name: ğŸ— Setup repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: ğŸ— Setup monorepo
        uses: ./.github/actions/setup-monorepo
        with:
          expo-token: ${{ secrets.EXPO_TOKEN }}
          rxdb-license-key: ${{ secrets.RXDB_LICENSE_KEY }}
          uniwind-auth-token: ${{ secrets.UNIWIND_AUTH_TOKEN }}

      - name: âœ… Build apps/main
        run: pnpm run -w build:main

      - name: ğŸŒ Export apps/main for web
        working-directory: apps/main
        run: pnpm expo export --platform web --output-dir ./build

      - name: ğŸš€ Deploy preview
        id: deploy-preview
        if: github.event_name == 'pull_request' || github.event.inputs.target == 'preview'
        working-directory: apps/main
        run: |
          # Deploy and capture output
          set +e
          OUTPUT=$(eas deploy --export-dir ./build --non-interactive --json 2>&1)
          EXIT_CODE=$?
          set -e
          
          echo "EAS output: $OUTPUT"
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo "::warning::EAS deploy exited with code $EXIT_CODE"
          fi
          
          # Extract URL from JSON output
          URL=$(echo "$OUTPUT" | grep -E '^\{' -A 100 | jq -r '.url // empty' 2>/dev/null || echo "")
          if [ -z "$URL" ]; then
            URL=$(echo "$OUTPUT" | grep -oE 'https://wcpos[a-zA-Z0-9._-]+\.expo\.app' | head -1 | tr -d '"' || echo "")
          fi
          
          # Fail if deployment failed AND no URL was extracted
          if [ $EXIT_CODE -ne 0 ] && [ -z "$URL" ]; then
            echo "::error::Deployment failed and no URL was extracted"
            exit 1
          fi
          
          echo "Deployment URL: $URL"
          echo "preview_url=$URL" >> $GITHUB_OUTPUT

      - name: ğŸš€ Deploy production
        id: deploy-production
        if: (github.event_name == 'push' && github.ref_name == 'main') || github.event.inputs.target == 'production'
        working-directory: apps/main
        run: |
          eas deploy --export-dir ./build --production
          echo "production_url=https://wcpos.expo.app" >> $GITHUB_OUTPUT

      - name: ğŸ“ Get deployment URL
        id: get-url
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ] || [ "${{ github.event.inputs.target }}" = "preview" ]; then
            echo "url=${{ steps.deploy-preview.outputs.preview_url }}" >> $GITHUB_OUTPUT
            echo "is_production=false" >> $GITHUB_OUTPUT
          else
            echo "url=https://wcpos.expo.app" >> $GITHUB_OUTPUT
            echo "is_production=true" >> $GITHUB_OUTPUT
          fi

  e2e:
    name: ğŸ­ E2E Tests
    needs: deploy
    if: needs.deploy.outputs.deployment_url != '' && (github.event_name != 'workflow_dispatch' || github.event.inputs.skip_e2e != 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: ğŸ— Setup repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: ğŸ— Setup monorepo
        uses: ./.github/actions/setup-monorepo
        with:
          expo-token: ${{ secrets.EXPO_TOKEN }}
          rxdb-license-key: ${{ secrets.RXDB_LICENSE_KEY }}
          uniwind-auth-token: ${{ secrets.UNIWIND_AUTH_TOKEN }}

      - name: ğŸ­ Install Playwright browsers
        run: cd apps/main && npx playwright install --with-deps chromium

      - name: ğŸ§ª Run E2E tests
        id: e2e-tests
        run: cd apps/main && npx playwright test
        env:
          BASE_URL: ${{ needs.deploy.outputs.deployment_url }}
          CI: true

      - name: ğŸ“Š Upload test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ github.sha }}
          path: apps/main/playwright-report/
          retention-days: 30

      - name: ğŸ“¸ Upload screenshots on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-screenshots-${{ github.sha }}
          path: apps/main/test-results/
          retention-days: 7

  comment:
    name: ğŸ’¬ PR Comment
    needs: [deploy, e2e]
    if: always() && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ’¬ Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const deployUrl = '${{ needs.deploy.outputs.deployment_url }}';
            const isProduction = '${{ needs.deploy.outputs.is_production }}' === 'true';
            const e2eResult = '${{ needs.e2e.result }}';
            const sha = '${{ github.sha }}'.substring(0, 7);
            
            let e2eStatus = 'â³ Pending';
            let e2eDetails = '';
            
            if (e2eResult === 'success') {
              e2eStatus = 'âœ… Passed';
            } else if (e2eResult === 'failure') {
              e2eStatus = 'âŒ Failed';
              e2eDetails = `\n\n[View test report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
            } else if (e2eResult === 'skipped') {
              e2eStatus = 'â­ï¸ Skipped';
            } else if (e2eResult === 'cancelled') {
              e2eStatus = 'ğŸš« Cancelled';
            }
            
            const tableRows = [
              '| Item | Status |',
              '|------|--------|',
              `| **Preview URL** | ${deployUrl ? '[' + deployUrl + '](' + deployUrl + ')' : 'âŒ Failed to deploy'} |`,
              `| **E2E Tests** | ${e2eStatus} |`,
              '| **Commit** | `' + sha + '` |'
            ].join('\n');
            
            let quickLinks = '';
            if (deployUrl) {
              quickLinks = `\n\n### ğŸ”— Quick Links\n- [Preview App](${deployUrl})\n- [Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
            }
            
            const body = `## ğŸš€ Deployment Summary\n\n${tableRows}${quickLinks}${e2eDetails}\n\n---\n<sub>ğŸ¤– Updated by GitHub Actions</sub>`;

            // Find and update existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('Deployment Summary')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
